<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"dongrongyu.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Rongyu&#39;s BigHouse">
<meta property="og:url" content="https://dongrongyu.github.io/index.html">
<meta property="og:site_name" content="Rongyu&#39;s BigHouse">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Rongyu">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://dongrongyu.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Rongyu's BigHouse</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Rongyu's BigHouse</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Welcome</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dongrongyu.github.io/2021/12/23/%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Rongyu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rongyu's BigHouse">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/23/%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">面试总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-23 21:39:32" itemprop="dateCreated datePublished" datetime="2021-12-23T21:39:32+08:00">2021-12-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-12-24 00:15:45" itemprop="dateModified" datetime="2021-12-24T00:15:45+08:00">2021-12-24</time>
              </span>

          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>10月份的面试已经结束有一段时间了，简单记录一下这次的面经。以下经验主要针对Java后端开发。</p>
<h1 id="面试情况"><a href="#面试情况" class="headerlink" title="面试情况"></a>面试情况</h1><p>统计了一下这次面试总共面15家公司，第一周主要集中面中小厂，第二周面大厂。我的面试节奏很快，每周面试基本上排满，最多的时候一天5面。一开始想着投中小厂练手，但后来发现投太多了，面试真的很耗精力，还是建议大家可以直接投大厂，或者投一家小厂练手。</p>
<p>前期先拿一个offer很重要，会给自己增加面试信心。如果没有offer的情况下，大厂可以直接要高，小厂想稳一手的话可以往低点要，小厂要高了可能直接不给发offer。</p>
<p>大厂和小厂都会考察八股文和算法，大厂的八股问题通常更加深入，算法题也会相对偏和难一些，但总体还是力扣简单和中等难度。大厂还可能会考察系统设计题。外企比较特殊，主要看算法题，别的不是很看重。</p>
<p>以下是自己各家的面试情况，供参考：</p>
<p><img src="/2021/12/23/%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93/image-20211224001538045.png" alt="image-20211224001538045"></p>
<h1 id="简历准备"><a href="#简历准备" class="headerlink" title="简历准备"></a>简历准备</h1><p>简历的准备是相当重要的，简历是你求职的门面，一方面是要体现你的优秀点确保过简历筛选关，另一方面是项目经历和技能要尽量和投递的岗位匹配，让面试官对你有兴趣。简历上主要的几块内容是教育背景、项目经历、个人技能。对面试官而言，最重要的是你的项目经历，其次是个人技能，这两块应该尽量和应聘岗位匹配。</p>
<p>简历其实是你给面试官提前准备的考卷，准备简历的时候应该预想到上面的内容都有可能被问到。对于研发而言，项目工作上应该尽可能写你的技术点，面试官通常对你的业务实现不感兴趣，比如项目中用到哪些中间件，做了哪些优化，指标提升了多少。个人技能也是，写到简历上的需要好好准备，也可以引导面试官问一些问题，比如对GC有一定理解，那么面试官会主动跳到你的坑里来。</p>
<p>对于简历的排版，每个人的审美标准不一样，我认为研发毕竟是做技术的，个人倾向于使用黑白简历，简历简单整洁就好了，内容不要过多，投国企可以用多页，投互联网内容最好控制在一页。这里分享一下我一直在用的简历模板，是个latex的简历模板，方便自己调整排版。</p>
<p>模板：<a target="_blank" rel="noopener" href="https://github.com/billryan/resume/tree/zh_CN">https://github.com/billryan/resume/tree/zh_CN</a></p>
<p>使用介绍：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzAwMjM3MTc5OA==&amp;mid=212258865&amp;idx=1&amp;sn=8ee6ccd56d86778e48207cedbb5fbfad&amp;3rd=MzA3MDU4NTYzMw==&amp;scene=6#rd%E3%80%82">https://mp.weixin.qq.com/s?__biz=MzAwMjM3MTc5OA==&amp;mid=212258865&amp;idx=1&amp;sn=8ee6ccd56d86778e48207cedbb5fbfad&amp;3rd=MzA3MDU4NTYzMw==&amp;scene=6#rd。</a></p>
<h1 id="面试准备"><a href="#面试准备" class="headerlink" title="面试准备"></a>面试准备</h1><h2 id="自我介绍"><a href="#自我介绍" class="headerlink" title="自我介绍"></a>自我介绍</h2><p>自我介绍一般控制在5分钟内，主要聊下下面几点内容：</p>
<ol>
<li>教育背景</li>
<li>工作经历和所属岗位</li>
<li>简单引出主要项目</li>
</ol>
<h2 id="项目介绍"><a href="#项目介绍" class="headerlink" title="项目介绍"></a>项目介绍</h2><p>通常每面面试过程面试官会让挑选一个项目进行介绍，所以着重准备一个项目就好了，当然其他的也需要简单准备下。</p>
<p>项目需要准备的几点：</p>
<ol>
<li>从产品层面介绍项目业务逻辑</li>
<li>项目的挑战点、技术点</li>
<li>项目用到的组件，最好了解一下组件的原理以及使用，比如常见的限流算法、缓存的设计模式等</li>
</ol>
<p>项目可能会问的问题：</p>
<ul>
<li>项目中有哪些技术困难点，是如何解决的？</li>
<li>XXX的实现这样是不是足够好？有没有其他的解决方式？</li>
</ul>
<p>面试多了会发现其实对一份简历的项目问题能问的还是比较固定的，这部分自己想不到的可以找有经验的朋友帮忙看看，提前准备可能被问的问题。</p>
<h2 id="专业知识"><a href="#专业知识" class="headerlink" title="专业知识"></a>专业知识</h2><p>工作3年内的工程师其实专业知识是主要考察点。</p>
<p>推荐教程：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://snailclimb.gitee.io/javaguide/#/">https://snailclimb.gitee.io/javaguide/#/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/CyC2018/CS-Notes">https://github.com/CyC2018/CS-Notes</a></li>
</ul>
<h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><p>语言和常用中间件的知识需要熟背，包括Java、mysql、redis、es、mq，其他的还可能考察IO、ZK、RPC、设计模式、分布式协议。当然这也看你简历上的技术栈怎么写了。总结了一些常见题。</p>
<p>Java：</p>
<ul>
<li>JVM内存模型</li>
<li>各种容器的实现原理，ArrayList、HashMap等</li>
<li>并发编程：Java线程池、ConcurrentHashMap原理、ThreadLocal、Atomic原子类、AQS</li>
<li>垃圾收集器：G1、CMS</li>
<li>内存泄露</li>
<li>spring</li>
<li>volatile关键字</li>
<li>spring bean生命周期</li>
<li>动态代理</li>
<li>代码问题定位</li>
</ul>
<p>mysql：</p>
<ul>
<li>索引原理、联合索引、聚簇索引</li>
<li>复制的同步模式</li>
<li>MVCC</li>
<li>redo、undo log</li>
<li>数据库范式</li>
<li>索引优化、explain看哪些指标</li>
<li>为什么不能有过多字段</li>
</ul>
<p>redis：</p>
<ul>
<li>zset跳表原理，zrank和zscore复杂度</li>
<li>主从同步原理</li>
<li>大key问题解决方法</li>
<li>脑裂问题</li>
<li>问题定位：cpu过高原因、变慢原因等</li>
</ul>
<p>es：</p>
<ul>
<li>倒排索引实现原理</li>
<li>近实时查询、写盘原理</li>
<li>filter和query的区别</li>
</ul>
<p>mq：</p>
<ul>
<li>producer、consumer、brocker</li>
<li>分区/队列</li>
<li>如何保证不丢消息</li>
<li>如何防止消息重复消费</li>
<li>rocketMQ延迟消息的实现</li>
</ul>
<p>其他的：</p>
<ul>
<li>多路复用IO</li>
<li>https的请求流程、对称加密和非对称加密、数字证书</li>
<li>raft算法选举原理</li>
</ul>
<h3 id="算法题"><a href="#算法题" class="headerlink" title="算法题"></a>算法题</h3><p>算法题其实大家工作时候很少去刷，社招又不像校招，其实没有时间刷那么多题，主要刷一部分题来找到刷题的手感。</p>
<p>刷题推荐两本书：剑指Offer、程序员代码面试指南。</p>
<p>剑指Offer是必刷的一本书，程序员代码面试指南因为题目太多了，所以建议每次刷的时候记录一下错题，下次再刷的时候就可以减少复习量啦~因为算法题一次不会的，下次可能也还是不会hh。</p>
<h3 id="系统设计"><a href="#系统设计" class="headerlink" title="系统设计"></a>系统设计</h3><p>系统设计题对我来说算是最难的一块，毕竟项目经验欠缺，而且日常工作中很少碰到复杂的系统设计。当然这块也有一些现成的方法论指导，提前准备准备，在问到的时候回答个五六成，基本上能满足对低年限招聘的需求。</p>
<p>推荐书籍：</p>
<ol>
<li>Groking the system design interview</li>
<li>数据密集型应用系统的设计</li>
<li>微服务架构设计模式</li>
<li>DDD</li>
</ol>
<p>这块没有提前准备，主要看了1的前面一部分，对临时抱佛脚还是很有帮助的。</p>
<p>自己碰到过的一些系统设计题：</p>
<ul>
<li><p>秒杀系统</p>
</li>
<li><p>兑奖码发放系统的设计</p>
</li>
<li><p>短视频推荐已看过滤</p>
</li>
</ul>
<h2 id="面试复盘"><a href="#面试复盘" class="headerlink" title="面试复盘"></a>面试复盘</h2><p>每一场面试都是对自己准备情况的考核，不会的和模棱两可的题都记录下来，下来看资料查漏补缺。你会发现，每场面试都有自己不会的问题。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>在当前互联网大环境下换工作总是免不了的，重要的是前期做好充分准备，面试过程中保持良好心态，面试结束后及时复盘。</p>
<p>出去面试也是对自己所学知识的查漏补缺，判断自己在市场的竞争力，我有朋友就是不换工作但偶尔出去面面试。</p>
<p>最后，祝大家面试顺利，都拿到心仪的offer~</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dongrongyu.github.io/2021/09/27/%E7%AC%AC6%E7%AB%A0-%E6%9F%A5%E8%AF%A2%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Rongyu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rongyu's BigHouse">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/27/%E7%AC%AC6%E7%AB%A0-%E6%9F%A5%E8%AF%A2%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">第6章-查询性能优化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-09-27 21:19:28 / 修改时间：21:19:41" itemprop="dateCreated datePublished" datetime="2021-09-27T21:19:28+08:00">2021-09-27</time>
            </span>

          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dongrongyu.github.io/2021/09/24/%E7%AC%AC3%E7%AB%A0-%E6%9C%8D%E5%8A%A1%E6%80%A7%E8%83%BD%E5%89%96%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Rongyu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rongyu's BigHouse">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/24/%E7%AC%AC3%E7%AB%A0-%E6%9C%8D%E5%8A%A1%E6%80%A7%E8%83%BD%E5%89%96%E6%9E%90/" class="post-title-link" itemprop="url">第3章-服务性能剖析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-24 15:17:35" itemprop="dateCreated datePublished" datetime="2021-09-24T15:17:35+08:00">2021-09-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-09-27 17:28:44" itemprop="dateModified" datetime="2021-09-27T17:28:44+08:00">2021-09-27</time>
              </span>

          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="剖析单条查询"><a href="#剖析单条查询" class="headerlink" title="剖析单条查询"></a>剖析单条查询</h2><h3 id="SHOW-PROFILE"><a href="#SHOW-PROFILE" class="headerlink" title="SHOW PROFILE"></a>SHOW PROFILE</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> profiling <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> sakila.nicer_but_slower_film_list;</span><br><span class="line"><span class="keyword">SHOW</span> PROFILES;</span><br><span class="line"><span class="keyword">SHOW</span> PROFILE <span class="keyword">FOR</span> QUERY <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p><img src="/%E7%AC%AC3%E7%AB%A0-%E6%9C%8D%E5%8A%A1%E6%80%A7%E8%83%BD%E5%89%96%E6%9E%90/image-20210924151946664.png" alt="image-20210924151946664"></p>
<p><img src="/%E7%AC%AC3%E7%AB%A0-%E6%9C%8D%E5%8A%A1%E6%80%A7%E8%83%BD%E5%89%96%E6%9E%90/image-20210924152049820.png" alt="image-20210924152049820"></p>
<p><img src="/%E7%AC%AC3%E7%AB%A0-%E6%9C%8D%E5%8A%A1%E6%80%A7%E8%83%BD%E5%89%96%E6%9E%90/image-20210924152200246.png" alt="image-20210924152200246"></p>
<h3 id="SHOW-STATUS"><a href="#SHOW-STATUS" class="headerlink" title="SHOW STATUS"></a>SHOW STATUS</h3><p><img src="/%E7%AC%AC3%E7%AB%A0-%E6%9C%8D%E5%8A%A1%E6%80%A7%E8%83%BD%E5%89%96%E6%9E%90/image-20210924153642994.png" alt="image-20210924153642994"></p>
<h3 id="使用慢查询日志"><a href="#使用慢查询日志" class="headerlink" title="使用慢查询日志"></a>使用慢查询日志</h3><h3 id="使用Performance-Schema"><a href="#使用Performance-Schema" class="headerlink" title="使用Performance Schema"></a>使用Performance Schema</h3><p>MySQL 5.5中新增的Performance Schema表, 还不支持查询级别的剖析信息.</p>
<p><img src="/%E7%AC%AC3%E7%AB%A0-%E6%9C%8D%E5%8A%A1%E6%80%A7%E8%83%BD%E5%89%96%E6%9E%90/image-20210924154438667.png" alt="image-20210924154438667"></p>
<h1 id="诊断间接性问题"><a href="#诊断间接性问题" class="headerlink" title="诊断间接性问题"></a>诊断间接性问题</h1><h2 id="单条语句问题还是服务器问题"><a href="#单条语句问题还是服务器问题" class="headerlink" title="单条语句问题还是服务器问题"></a>单条语句问题还是服务器问题</h2><h3 id="SHOW-GLOBAL-STATUS"><a href="#SHOW-GLOBAL-STATUS" class="headerlink" title="SHOW GLOBAL STATUS"></a>SHOW GLOBAL STATUS</h3><p>下面命令每s捕获一次SHOW GLOBAL STATUS: 查询数, Threads_connected, Threads_running</p>
<p><img src="/%E7%AC%AC3%E7%AB%A0-%E6%9C%8D%E5%8A%A1%E6%80%A7%E8%83%BD%E5%89%96%E6%9E%90/image-20210926180713989.png" alt="image-20210926180713989"></p>
<p>通过观察尖刺进行分析</p>
<p>可能原因: 查询竞争锁, 缓存失效</p>
<h3 id="使用SHOW-PROCESSLIST"><a href="#使用SHOW-PROCESSLIST" class="headerlink" title="使用SHOW PROCESSLIST"></a>使用SHOW PROCESSLIST</h3><p>周期性捕获 SHOW PROCESSLIST. 也可直接查询INFORMATION_SCHEMA中的PROCESSLIST表</p>
<p>原因: InnoDB内部的征用和脏块刷新所导致的</p>
<p><img src="/%E7%AC%AC3%E7%AB%A0-%E6%9C%8D%E5%8A%A1%E6%80%A7%E8%83%BD%E5%89%96%E6%9E%90/image-20210926181214669.png" alt="image-20210926181214669"></p>
<h3 id="使用查询日志"><a href="#使用查询日志" class="headerlink" title="使用查询日志"></a>使用查询日志</h3><p>慢查询记录所有日志, tcpdump, pt-query-digest</p>
<h3 id="需要手机什么样的数据"><a href="#需要手机什么样的数据" class="headerlink" title="需要手机什么样的数据"></a>需要手机什么样的数据</h3><p>系统的状态, CPU利用率, 磁盘使用率和可用空间, ps的输出采样, 内存利用率</p>
<p>MySQL信息 (SHOW STATUS, SHOW PROCESSLIST, SHOW INNODB STATUS)</p>
<p>执行时间: 工作时间, 等待时间</p>
<p>oprofile 服务器内部诊断</p>
<p>strace 剖析服务器系统调用</p>
<p>tcpdump 监听TCP流量</p>
<p>gdb 堆栈跟踪, 启动并attach到mysqld进程. pt-pmp工具</p>
<p>pt-collect工具, 通过pt-stalk调用</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dongrongyu.github.io/2021/09/22/%E7%AC%AC2%E7%AB%A0-MySQL%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Rongyu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rongyu's BigHouse">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/22/%E7%AC%AC2%E7%AB%A0-MySQL%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/" class="post-title-link" itemprop="url">第2章-MySQL基准测试</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-09-22 20:40:55 / 修改时间：20:41:14" itemprop="dateCreated datePublished" datetime="2021-09-22T20:40:55+08:00">2021-09-22</time>
            </span>

          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dongrongyu.github.io/2021/09/17/%E7%AC%AC1%E7%AB%A0-MySQL%E6%9E%B6%E6%9E%84%E4%B8%8E%E5%8E%86%E5%8F%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Rongyu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rongyu's BigHouse">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/17/%E7%AC%AC1%E7%AB%A0-MySQL%E6%9E%B6%E6%9E%84%E4%B8%8E%E5%8E%86%E5%8F%B2/" class="post-title-link" itemprop="url">第1章-MySQL架构与历史</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-17 15:56:09" itemprop="dateCreated datePublished" datetime="2021-09-17T15:56:09+08:00">2021-09-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-09-22 16:03:56" itemprop="dateModified" datetime="2021-09-22T16:03:56+08:00">2021-09-22</time>
              </span>

          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><p>SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITED: 设置当前会话的隔离级别, 下一个事务开始时生效</p>
<p>也可在配置文件中修改全局的</p>
<p>MVVC (InnoDB)</p>
<p>两个隐藏列: 创建时间, 过期(删除)时间</p>
<p>存储的是系统版本号, 每开启一个新的事务, 系统版本号会自动递增</p>
<p>SELECT:</p>
<ul>
<li>只查找创建时间大于等于事务版本号的数据行</li>
<li>行的删除版本号要么没定义, 要么大于当前事务版本号</li>
</ul>
<p>INSERT: 保存当前系统版本号为创建时间</p>
<p>DELETE: 当前系统版本号保存为该行的删除时间</p>
<p>UPDATE: </p>
<ul>
<li>插入一行新记录, 当前版本号作为创建时间</li>
<li>当前版本号为原记录的删除时间</li>
</ul>
<p>只在REPEATABLE READ和READ COMMITED两个隔离级别下工作</p>
<h1 id="MySQL的存储引擎"><a href="#MySQL的存储引擎" class="headerlink" title="MySQL的存储引擎"></a>MySQL的存储引擎</h1><p>table.frm保存了表定义, MySQL服务层统一处理</p>
<p>SHOW TABLE STATUS LIKE ‘user’: 显示表的相关信息</p>
<p><img src="/%E7%AC%AC1%E7%AB%A0-MySQL%E6%9E%B6%E6%9E%84%E4%B8%8E%E5%8E%86%E5%8F%B2/image-20210917162059689.png" alt="image-20210917162059689"></p>
<p><img src="/%E7%AC%AC1%E7%AB%A0-MySQL%E6%9E%B6%E6%9E%84%E4%B8%8E%E5%8E%86%E5%8F%B2/image-20210917162358560.png" alt="image-20210917162358560"></p>
<p><img src="/%E7%AC%AC1%E7%AB%A0-MySQL%E6%9E%B6%E6%9E%84%E4%B8%8E%E5%8E%86%E5%8F%B2/image-20210917162414790.png" alt="image-20210917162414790"></p>
<p><img src="/%E7%AC%AC1%E7%AB%A0-MySQL%E6%9E%B6%E6%9E%84%E4%B8%8E%E5%8E%86%E5%8F%B2/image-20210917162427208.png" alt="image-20210917162427208"></p>
<h2 id="转换表的引擎"><a href="#转换表的引擎" class="headerlink" title="转换表的引擎"></a>转换表的引擎</h2><p>ALTER Table</p>
<ul>
<li><img src="/%E7%AC%AC1%E7%AB%A0-MySQL%E6%9E%B6%E6%9E%84%E4%B8%8E%E5%8E%86%E5%8F%B2/image-20210922150903901.png" alt="image-20210922150903901"></li>
</ul>
<p>导出与导入</p>
<ul>
<li>mysqldump导出到文件</li>
<li>修改CREATE TABLE的存储引擎选项</li>
<li>修改表明 (mysqldump会在CREATE TABLE前加上DROP TABLE)</li>
</ul>
<p>创建与查询 (CREATE和SELECT)</p>
<ul>
<li><img src="/%E7%AC%AC1%E7%AB%A0-MySQL%E6%9E%B6%E6%9E%84%E4%B8%8E%E5%8E%86%E5%8F%B2/image-20210922151056005.png" alt="image-20210922151056005"></li>
<li>数据量大时分批处理 (可以在执行过程对原表加锁, 确保数据一致)</li>
<li><img src="/%E7%AC%AC1%E7%AB%A0-MySQL%E6%9E%B6%E6%9E%84%E4%B8%8E%E5%8E%86%E5%8F%B2/image-20210922151134036.png" alt="image-20210922151134036"></li>
<li>pt-online-schema-change工具替代手工执行上述操作</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dongrongyu.github.io/2021/03/02/%E7%AC%AC5%E7%AB%A0-%E8%B0%83%E4%BC%98%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90%E4%B8%8E%E5%AE%9E%E6%88%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Rongyu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rongyu's BigHouse">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/02/%E7%AC%AC5%E7%AB%A0-%E8%B0%83%E4%BC%98%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90%E4%B8%8E%E5%AE%9E%E6%88%98/" class="post-title-link" itemprop="url">第5章-调优案例分析与实战</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-02 15:18:28" itemprop="dateCreated datePublished" datetime="2021-03-02T15:18:28+08:00">2021-03-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-03-03 11:28:08" itemprop="dateModified" datetime="2021-03-03T11:28:08+08:00">2021-03-03</time>
              </span>

          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="案例分析"><a href="#案例分析" class="headerlink" title="案例分析"></a>案例分析</h1><h2 id="大内存硬件上程序部署策略"><a href="#大内存硬件上程序部署策略" class="headerlink" title="大内存硬件上程序部署策略"></a>大内存硬件上程序部署策略</h2><p>部署方式:</p>
<ul>
<li>一个单独的Java虚拟机实例管理大量Java堆内存</li>
<li>同时使用若干个Java虚拟机, 建立逻辑集群利用硬件资源</li>
</ul>
<h3 id="单个虚拟机实例"><a href="#单个虚拟机实例" class="headerlink" title="单个虚拟机实例"></a>单个虚拟机实例</h3><p>合理写代码, 尽量避免Full GC</p>
<p>面临问题:</p>
<ul>
<li>回收大块堆内存导致长时间停顿. 采用增量回收, G1, ZGC, Shenandoah</li>
<li>大内存必须使用64位Java虚拟机. 由于压缩至真, 处理器缓存行容量等因素, 性能低于32位虚拟机</li>
<li>应用必须稳定, 避免使用期间Full GC</li>
<li>相同程序在64位虚拟机占用空间更大 (压缩指针缓解)</li>
</ul>
<h3 id="逻辑集群方式部署"><a href="#逻辑集群方式部署" class="headerlink" title="逻辑集群方式部署"></a>逻辑集群方式部署</h3><p>在一台物理机器上启动多个应用服务器进程, 为每个服务器进程分配不同端口, 然后在前端搭建一个负载均衡器,以反向代理的方式来分配访问请求</p>
<p>面临问题:</p>
<ul>
<li>节点竞争全局资源, 如磁盘文件竞争</li>
<li>难高效利用资源池, 如连接池, 有些空闲有些繁忙</li>
<li>使用32位虚拟机的话, 收到内存限制</li>
<li>使用本地缓存的话, 内存浪费, 数据被缓存多份</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dongrongyu.github.io/2021/02/28/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Rongyu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rongyu's BigHouse">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/28/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0/" class="post-title-link" itemprop="url">Redis设计与实现-单机数据库的实现</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-28 00:43:14" itemprop="dateCreated datePublished" datetime="2021-02-28T00:43:14+08:00">2021-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-22 15:56:27" itemprop="dateModified" datetime="2021-08-22T15:56:27+08:00">2021-08-22</time>
              </span>

          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  redisDb *db;   <span class="comment">// 一个数组, 保存服务器中的所有数据库</span></span><br><span class="line">  <span class="keyword">int</span> dbnum;     <span class="comment">// 服务器的数据库数量, 默认16. 初始化时, 根据创建dbnum个数据库</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisClient</span> &#123;</span></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	redisDb *db;   <span class="comment">// 记录客户端正在使用的数据库</span></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125; redisClient;</span><br></pre></td></tr></table></figure>
<p>SELECT命令: 显示的切换到一个数据库. 在执行FLUSHDB这样的危险命令前最好SELECT到需要执行FLUSHDB的目标数据库</p>
<p><img src="/2021/02/28/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20210228005024994.png" alt="image-20210228005024994"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisDb</span> &#123;</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  dict *dict;   <span class="comment">// 数据库键空间, 是一个字典, 保存着数据库中的所有键值对</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125; redisDb;</span><br></pre></td></tr></table></figure>
<p>键值对: 键+值</p>
<ul>
<li>键: 字符串对象</li>
<li>值: 字符串对象, 列表对象, 哈希表对象, 集合对象, 有序集合对象, 这些对象中的任一类型</li>
</ul>
<p><img src="/2021/02/28/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20210228005612084.png" alt="image-20210228005612084"></p>
<h2 id="读写键空间的维护操作"><a href="#读写键空间的维护操作" class="headerlink" title="读写键空间的维护操作"></a>读写键空间的维护操作</h2><p>更新键空间的hit, miss次数. INFO status</p>
<p>更新键LRU</p>
<p>读取键时发现键过期, 则会先删除过期键再执行其他操作.</p>
<p>标记dirty: 如果有客户端WATCH某个键, 则修改后会标记dirty</p>
<p>增加dirty counter: 每次修改一个键后, 都会对脏键计数器的值增1</p>
<p>修改操作发送数据库通知: 开启了数据库通知时, 服务器将按配置发送相应的数据库通知</p>
<h2 id="设置键的生存时间或过期时间"><a href="#设置键的生存时间或过期时间" class="headerlink" title="设置键的生存时间或过期时间"></a>设置键的生存时间或过期时间</h2><p>服务器会自动删除生存时间TTL为0的键</p>
<p>设置过期时间方式, 这几个命令底层都是使用PEXPIREAT命令实现的:</p>
<ul>
<li><p>EXPIRE, PEXPIRE: 以s或者ms为精度为某个键设置TTL, 相对时间, 多长时间之后</p>
</li>
<li><p>EXPIREAT, PEXPIREAT: 以s或者ms设置过期时间戳</p>
</li>
</ul>
<p>TTL, PTTL: 返回键的剩余TTL</p>
<p>PERSIST: 移除一个键的过期时间</p>
<h2 id="保存过期时间"><a href="#保存过期时间" class="headerlink" title="保存过期时间"></a>保存过期时间</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisDb</span> &#123;</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  dict *expire;   <span class="comment">// expire字典保存了数据库中所有键的过期时间</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125; redisDb;</span><br></pre></td></tr></table></figure>
<p>expire的键值对:</p>
<ul>
<li>键是一个指针, 指向某个数据库键对象 (和键空间字典的键指向同一个键对象)</li>
<li>值是一个long long类型的整数, 保存了数据库键的过期时间戳</li>
</ul>
<p><img src="/2021/02/28/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20210228011531391.png" alt="image-20210228011531391"></p>
<h2 id="过期删除策略"><a href="#过期删除策略" class="headerlink" title="过期删除策略"></a>过期删除策略</h2><h3 id="三种删除策略"><a href="#三种删除策略" class="headerlink" title="三种删除策略"></a>三种删除策略</h3><ul>
<li>定时删除: 设置过期时间同时设置定时器, 在键过期时立即删除<ul>
<li>需要创建定时器, Redis时间事件采用无需链表, 查找时间复杂度O(N), 效率差</li>
<li>对内存友好, 对CPU不友好</li>
</ul>
</li>
<li>惰性删除: 每次从键空间获取键时, 检查是否过期, 过期则删除<ul>
<li>对CPU友好, 对内存不友好</li>
</ul>
</li>
<li>定期删除: 每隔一段时间, 对数据库进行一次检查, 删除全部或部分过期键<ul>
<li>定期执行, 并限制删除操作执行的时长和频率</li>
<li>难点在于执行时长和频率的设置</li>
</ul>
</li>
</ul>
<p>Redis结合使用了惰性删除和定期删除</p>
<h3 id="惰性删除流程"><a href="#惰性删除流程" class="headerlink" title="惰性删除流程"></a>惰性删除流程</h3><p>epireIfNeeded函数: 如果键过期则将键从数据库中删除</p>
<p><img src="/2021/02/28/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20210228160950463.png" alt="image-20210228160950463"></p>
<h3 id="定期删除策略流程"><a href="#定期删除策略流程" class="headerlink" title="定期删除策略流程"></a>定期删除策略流程</h3><p>每次运行, 都从一定数量的数据库中取出一定数量的随机键 (DEFAULT_KEY_NUMBERS) 进行检查, 并删除其中的过期键</p>
<p>current_db会记录当前activeExpireCycle函数检查的进度, 并在下一次activeExpireCycle函数调用时, 接着上一次的进度进行处理. 本次在10号db返回, 下次从11号db开始</p>
<p>所有数据库都检查过一遍后, current_db = 0, 开始新一轮的检查</p>
<h2 id="AOF-RDB和复制功能对过期键的处理"><a href="#AOF-RDB和复制功能对过期键的处理" class="headerlink" title="AOF, RDB和复制功能对过期键的处理"></a>AOF, RDB和复制功能对过期键的处理</h2><h3 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h3><p>保存RDB:</p>
<ul>
<li>已过期的键不会保存到RDB文件中</li>
</ul>
<p>载入RDB:</p>
<ul>
<li>主服务模式, 过期键不会被载入</li>
<li>从服务器模式, 过期键会被载入</li>
</ul>
<h4 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h4><p>AOF文件写入: 过期键被惰性删除或定期删除后, 程序想AOF文件append一条DEL记录, 显示记录该键已被删除</p>
<p>AOF重写: 已过期的键不保存到重写的AOF文件</p>
<h4 id="复制-从服务器"><a href="#复制-从服务器" class="headerlink" title="复制 (从服务器)"></a>复制 (从服务器)</h4><p>只有收到主服务器的DEL命令才删除, 否则过期也不删除.</p>
<p>如果客户端请求过期键, 从服务器还是会返回客户端结果</p>
<h2 id="通知"><a href="#通知" class="headerlink" title="通知"></a>通知</h2><p>客户端可以对某个数据库中的特定键进行订阅, 获取该键的执行情况 (SET, EXPIRE, DEL等)</p>
<p>类型:</p>
<ul>
<li><p>键空间通知: 某个键执行了什么命令</p>
<ul>
<li><p><img src="/2021/02/28/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20210228163051266.png" alt="image-20210228163051266"></p>
<p><img src="/2021/02/28/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20210228163155006.png" alt="image-20210228163155006"></p>
</li>
</ul>
</li>
<li><p>键事件通知: 某个操作被什么键执行了</p>
<ul>
<li><img src="/2021/02/28/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20210228163209884.png" alt="image-20210228163209884"></li>
</ul>
</li>
</ul>
<p>notify-keyspace-events选项决定了服务器所发送通知的类型:</p>
<ul>
<li>AKE: 所有类型键空间通知和键事件通知</li>
<li>AK: 所有类型键空间通知</li>
<li>AE: 所有类型键事件通知</li>
<li>K$: 字符串键键空间通知</li>
<li>EI: 列表键键事件通知</li>
</ul>
<h3 id="发送通知"><a href="#发送通知" class="headerlink" title="发送通知"></a>发送通知</h3><p>由notify.c/notifyKeyspaceEvent函数实现</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// event: 事件名称, key: 产生事件的键, dbid: 数据库号码</span></span><br><span class="line"><span class="comment">// type: 通知类型, REDIS_NOTIFY_SET集合键通知, REDIS_NOTIFY_GENERIC通用类型通知</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notifyKeyspaceEvent</span><span class="params">(<span class="keyword">int</span> type, <span class="keyword">char</span> *event, robj *key, <span class="keyword">int</span> dbid)</span></span>;</span><br></pre></td></tr></table></figure>
<p>通知例子:</p>
<p><img src="/2021/02/28/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20210228164254419.png" alt="image-20210228164254419"></p>
<p><img src="/2021/02/28/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20210228164306088.png" alt="image-20210228164306088"></p>
<p><img src="/2021/02/28/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20210228164315172.png" alt="image-20210228164315172"></p>
<h4 id="通知函数的实现"><a href="#通知函数的实现" class="headerlink" title="通知函数的实现"></a>通知函数的实现</h4><ol>
<li>给定通知类型是否是服务器允许发送的类型server.notify_keyspace_events, 不是则直接返回</li>
<li>是否允许发送键空间通知, 允许则发送</li>
<li>是否允许发送键事件通知, 允许则发送</li>
</ol>
<p><img src="/2021/02/28/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20210228164807639.png" alt="image-20210228164807639"></p>
<h1 id="RDB持久化"><a href="#RDB持久化" class="headerlink" title="RDB持久化"></a>RDB持久化</h1><p>RDB文件创建</p>
<ul>
<li>SAVE: 同步生成RDB文件, Redis服务器进程阻塞</li>
<li>BGSAVE: 派生一个子进程异步创建RDB文件, Redis服务器进程继续处理请求<ul>
<li>BGSAVE执行过程中, BGREWRITEAOF命令会被延迟到BGSAVE完成后执行</li>
<li>BGREWRITEAOF执行过程中, BGSAVE会被拒绝</li>
</ul>
</li>
</ul>
<p>RDB文件载入: 在启动时载入, 无特定命令</p>
<p>AOF更新频率比RDB高, 所以只有在关闭AOF时才使用RDB还原数据库</p>
<h2 id="自动间隔性保存"><a href="#自动间隔性保存" class="headerlink" title="自动间隔性保存"></a>自动间隔性保存</h2><h3 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h3><p><img src="/2021/02/28/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20210228165935164.png" alt="image-20210228165935164"></p>
<p><img src="/2021/02/28/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20210228165949628.png" alt="image-20210228165949628"></p>
<h3 id="保存条件"><a href="#保存条件" class="headerlink" title="保存条件"></a>保存条件</h3><p>设置保存条件, 任意一条被满足就会触发:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">save 900 1        &#x2F;&#x2F; 服务器在900s内, 对数据库进行了至少1次修改</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br></pre></td></tr></table></figure>
<p>dirty计数器: 距离上一次成功执行SAVE或BGSAVE后, 进行了多少次修改</p>
<p>lastsave: 上一次成功执行SAVE或BGSAVE的时间戳</p>
<p><img src="/2021/02/28/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20210228170212541.png" alt="image-20210228170212541"></p>
<h3 id="检查条件是否满足"><a href="#检查条件是否满足" class="headerlink" title="检查条件是否满足"></a>检查条件是否满足</h3><p>serverCron默认100ms执行一次, 其中一项工作是检查save的条件是否满足</p>
<p><img src="/2021/02/28/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20210228170533691.png" alt="image-20210228170533691"></p>
<p><img src="/2021/02/28/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20210228170546608.png" alt="image-20210228170546608"></p>
<h2 id="RDB文件结构"><a href="#RDB文件结构" class="headerlink" title="RDB文件结构"></a>RDB文件结构</h2><p><img src="/2021/02/28/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0/image-20210228170611991.png" alt="image-20210228170611991"></p>
<p>REDIS: 固定REDIS这5个字符</p>
<p>db_version: 版本, 0006</p>
<p>databases: 0个或任意多个数据, 及库中的键值对</p>
<p>EOF: 1字节, 标识结束</p>
<p>check_sum: 对前4个部分计算的校验和</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dongrongyu.github.io/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Rongyu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rongyu's BigHouse">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/" class="post-title-link" itemprop="url">Redis涉及与实现 - 数据结构与对象</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-19 23:20:54" itemprop="dateCreated datePublished" datetime="2021-02-19T23:20:54+08:00">2021-02-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-28 00:38:45" itemprop="dateModified" datetime="2021-02-28T00:38:45+08:00">2021-02-28</time>
              </span>

          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Redis底层数据结构:</p>
<ul>
<li>SDS: 简单动态字符串, simple dynamic string</li>
<li>链表</li>
<li>字典</li>
<li>跳跃表</li>
<li>整数集合</li>
<li>压缩列表</li>
</ul>
<p>Redis的5种对象类型和底层数据结构的对应关系:</p>
<table>
<thead>
<tr>
<th>键类型</th>
<th>底层实现</th>
</tr>
</thead>
<tbody><tr>
<td>字符串对象</td>
<td>SDS</td>
</tr>
<tr>
<td>列表对象</td>
<td>压缩列表 (元素长度短且元素数量少时), 双端链表</td>
</tr>
<tr>
<td>哈希对象</td>
<td>压缩列表 (少量键值对且每个键值对键和值是小整数值或长度比较短的字符串), 字典</td>
</tr>
<tr>
<td>集合对象</td>
<td>整数集合 (元素均为整数值且数量不多时), 跳跃表</td>
</tr>
<tr>
<td>有序集合对象</td>
<td>压缩列表 (元素长度短且数量较少时), 跳跃表</td>
</tr>
</tbody></table>
<h1 id="SDS"><a href="#SDS" class="headerlink" title="SDS"></a>SDS</h1><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p>simple dynamic string, 简单动态字符串</p>
<p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210220005705662.png" alt="image-20210220005705662"></p>
<p>sizeof(buf) = len + free + 1</p>
<h2 id="空间重分配"><a href="#空间重分配" class="headerlink" title="空间重分配"></a>空间重分配</h2><h3 id="空间预分配"><a href="#空间预分配" class="headerlink" title="空间预分配"></a>空间预分配</h3><p>SDS修改, 发生空间扩展</p>
<ul>
<li>扩展后 len &lt;  1MB: 预分配 free = len, sizeof(buf) = free + len + 1</li>
<li>扩展后 len &gt; 1MB: 预分配 free = 1MB, sizeof(buf) = len + free(1MB) + 1</li>
</ul>
<h3 id="惰性空间释放"><a href="#惰性空间释放" class="headerlink" title="惰性空间释放"></a>惰性空间释放</h3><p>SDS缩短时, 不立即释放空间.</p>
<p>SDS提供了相应的API, 在有需要时真正释放SDS</p>
<h3 id="二进制安全"><a href="#二进制安全" class="headerlink" title="二进制安全"></a>二进制安全</h3><p>通过len记录长度而不是‘\0’</p>
<h2 id="相比C字符串的优点"><a href="#相比C字符串的优点" class="headerlink" title="相比C字符串的优点"></a>相比C字符串的优点</h2><ul>
<li>常数复杂度获取字符串长度</li>
<li>杜绝缓冲区溢出</li>
<li>减少重分配次数</li>
<li>二进制安全</li>
<li>兼容部分C字符串函数</li>
</ul>
<h1 id="链表"><a href="#链表" class="headerlink" title="链表"></a>链表</h1><h2 id="结构-1"><a href="#结构-1" class="headerlink" title="结构"></a>结构</h2><p>双向链表</p>
<p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210220233615752.png" alt="image-20210220233615752"></p>
<h3 id="节点结构"><a href="#节点结构" class="headerlink" title="节点结构"></a>节点结构</h3><p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210220232954579.png" alt="image-20210220232954579"></p>
<h3 id="链表结构"><a href="#链表结构" class="headerlink" title="链表结构"></a>链表结构</h3><p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210220233103318.png" alt="image-20210220233103318"></p>
<h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><ul>
<li>双端</li>
<li>无环</li>
<li>带表头和表尾指针</li>
<li>带链表长度计数器</li>
<li>多态: 值类型void* (可保存各种不同类型的值), dup、free、match函数可自定义</li>
</ul>
<h1 id="字典"><a href="#字典" class="headerlink" title="字典"></a>字典</h1><h2 id="结构-2"><a href="#结构-2" class="headerlink" title="结构"></a>结构</h2><p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210221234456492.png" alt="image-20210221234456492"></p>
<h3 id="字典结构"><a href="#字典结构" class="headerlink" title="字典结构"></a>字典结构</h3><p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210220234550734.png" alt="image-20210220234550734"></p>
<p>dictType: 一簇用于操作特定类型键值对的函数, Redis为不同用途的字典设置不同类型的特定函数</p>
<p>privdata: 需要传给类型特定函数的可选参数</p>
<h4 id="dictType"><a href="#dictType" class="headerlink" title="dictType"></a>dictType</h4><p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210221234415105.png" alt="image-20210221234415105"></p>
<h3 id="哈希表"><a href="#哈希表" class="headerlink" title="哈希表"></a>哈希表</h3><p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210220234445307.png" alt="image-20210220234445307"></p>
<h3 id="哈希表节点"><a href="#哈希表节点" class="headerlink" title="哈希表节点"></a>哈希表节点</h3><p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210220234521971.png" alt="image-20210220234521971"></p>
<h2 id="rehash"><a href="#rehash" class="headerlink" title="rehash"></a>rehash</h2><p>为了让哈希表负载因子维持在一个合理范围, 字典可能进行扩展和收缩, 进行rehash</p>
<p>负载因子: load_factor = ht[0].used / ht[0].size</p>
<p>步骤:</p>
<ol>
<li>为ht[1]分配空间<ul>
<li>扩展: h[1]的大小为第一个大于等于ht[0].used*2的2^n</li>
<li>收缩: h[1]的大小为第一个大于等于ht[0].used的2^n</li>
</ul>
</li>
<li>h[0]的元素rehash到h[1]上</li>
<li>所有元素rehash完成后, 释放h[0], h[0] = h[1], h[1]创建一张空表</li>
</ol>
<p>扩展和收缩的条件:</p>
<ol>
<li>服务器没有执行BGSAVE或BGREWRITEAOF, 负载因子大于等于1</li>
<li>服务器在执行BGSAVE或BGREWRITEAOF, 负载因子大于等于5</li>
<li>负载因子小于0.1时执行收缩操作</li>
</ol>
<p>渐进式rehash:</p>
<ul>
<li>字典每次的添加、删除、查找、更新操作时, 将ht[0]中rehashidx索引上的键值对rehash到ht[1]中, 且rehashidx++</li>
<li>rehash完成时rehashidx设为-1</li>
<li>rehash的操作负载均摊到每个CRUD操作中, 避免单次计算量过大</li>
<li>rehash过程中的CUD操作会同时检索ht[0]和ht[1]</li>
</ul>
<h1 id="跳跃表"><a href="#跳跃表" class="headerlink" title="跳跃表"></a>跳跃表</h1><p>平均O(logN)、最坏O(N)的节点查找</p>
<h2 id="结构-3"><a href="#结构-3" class="headerlink" title="结构"></a>结构</h2><p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210222000803717.png" alt="image-20210222000803717"></p>
<p>level: 层数最大节点的层数</p>
<p>length: 跳跃表的长度, 表头节点不计</p>
<h3 id="zskiplistNode"><a href="#zskiplistNode" class="headerlink" title="zskiplistNode"></a>zskiplistNode</h3><p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210222001104268.png" alt="image-20210222001104268"></p>
<p>层: 每创建一个节点, 根绝幂次定律, 随机生成一个介于1~32的值最为level数组的大小, 也即层的高度</p>
<p>跨度: 两个节点之间的距离, 计算节点在跳跃表中的排位 (rank)</p>
<p>后退指针: 不指向表头节点</p>
<p>score: 用于节点间的比较. 多个节点<strong>可以相同</strong></p>
<p>obj: 指向一个字符串对象, 字符串对象保存一个SDS值. <strong>必须唯一</strong></p>
<h1 id="整数集合"><a href="#整数集合" class="headerlink" title="整数集合"></a>整数集合</h1><p>intset, 集合中不会重现重复元素</p>
<p>元素类型: int16_t、int32_t或int64_t</p>
<p>元素按从小到大的顺序在contents中存储</p>
<p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210222012539715.png" alt="image-20210222012539715"></p>
<h2 id="结构-4"><a href="#结构-4" class="headerlink" title="结构"></a>结构</h2><p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210222011545836.png" alt="image-20210222011545836"></p>
<p>encoding: INTSET_ENC_INT16, INTSET_ENC_INT32, INTSET_ENC_INT64</p>
<p>元素实际类型由encoding决定, 并不保存int8_t</p>
<h2 id="升级"><a href="#升级" class="headerlink" title="升级"></a>升级</h2><p>新元素类型比现有类型要大时, 需要升级</p>
<p>复杂度O(N)</p>
<p>步骤: </p>
<ol>
<li>根绝新元素类型, 扩展整数集合, 并为新元素分配空间</li>
<li>将所有元素转成和新元素相同类型, 从后往前放到新空间上</li>
<li>添加新元素</li>
<li>length++</li>
</ol>
<p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210222012556585.png" alt="image-20210222012556585"></p>
<p>整数集合只支持升级不支持降级</p>
<h1 id="压缩列表"><a href="#压缩列表" class="headerlink" title="压缩列表"></a>压缩列表</h1><p>节省内存, 连续内存块组成的顺序型结构, 每个节点可以保存一个字节数组或者一个整数值</p>
<h2 id="结构-5"><a href="#结构-5" class="headerlink" title="结构"></a>结构</h2><p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210224004646363.png" alt="image-20210224004646363"></p>
<p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210224004656656.png" alt="image-20210224004656656"></p>
<h3 id="节点结构-1"><a href="#节点结构-1" class="headerlink" title="节点结构"></a>节点结构</h3><p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210224005253997.png" alt="image-20210224005253997"></p>
<h4 id="content"><a href="#content" class="headerlink" title="content"></a>content</h4><p>字节数组或者整数值 </p>
<ul>
<li><p>字节数组</p>
<ul>
<li>长度小于等于63 (2^6-1)的字节数组</li>
<li>长度小于等于16383 (2^14-1)</li>
<li>长度小于等于4294967295 (2^32-1)</li>
</ul>
</li>
<li><p>整数值</p>
<ul>
<li>4位长, 0~12间的无符号整数</li>
<li>1字节的有符号整数</li>
<li>3字节的有符号整数</li>
<li>int16_t</li>
<li>int32_t</li>
<li>Int64_t</li>
</ul>
</li>
</ul>
<h4 id="previous-entry-length"><a href="#previous-entry-length" class="headerlink" title="previous_entry_length"></a>previous_entry_length</h4><p>1字节或者5字节, 记录前一个节点的长度</p>
<ul>
<li>1字节: 前一个节点长度小于254</li>
<li>5字节: 前一个节点长度大于等于254, 第一个节点设置为0xFE (254), 之后四个字节保存长度</li>
</ul>
<p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210225010124103.png" alt="image-20210225010124103"></p>
<p>前一个节点的起始地址 = 当前节点的起始地址 - previous_entry_length</p>
<p>利用该字段压缩列表可以实现从表尾向表头的遍历</p>
<h4 id="encoding"><a href="#encoding" class="headerlink" title="encoding"></a>encoding</h4><p>记录content保存数据的类型和长度</p>
<ul>
<li>字节数组编码: 1字节, 2字节或5字节, 最高位00, 01, 10开头</li>
<li>整数编码: 该字段1字节, 最高位以11开头, 类型和长度由剩余6位决定</li>
</ul>
<p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210225010818422.png" alt="image-20210225010818422"></p>
<h2 id="连锁更新"><a href="#连锁更新" class="headerlink" title="连锁更新"></a>连锁更新</h2><p>添加和删除在特定情况下, 会引发所有节点长度的更新, 引发N次重分配, 每次重分配最坏复杂度位O(N), 所以连锁更新最坏复杂度位O(N^2)</p>
<ul>
<li><p>添加情况下的连锁更新: 所有节点e1~eN长度都为250~253字节之间, 在表头添加一个长度大于254的节点, 则所有节点都需要扩展</p>
</li>
<li><p>删除情况下的连锁更新: 节点排列big, small, e1~eN, e1~eN长度介于250~253, small小于254, big大于等于254. 删除small引发e1~eN的连锁更新</p>
</li>
</ul>
<h1 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h1><p>Redis对象种类: 字符串对象, 列表对象, 哈希对象, 集合对象, 有序集合对象</p>
<p>对象的实现基于前文的基本数据结构, 且同一个对象在不同场景可能会采取不同的底层结构</p>
<p>对象系统基于引用计数内存回收. 在适当条件下多个数据库建会共享同一快内存</p>
<p>对象带有访问时间记录</p>
<p>Redis键值对: 建对象 (字符串对象) + 值对象</p>
<h2 id="结构-6"><a href="#结构-6" class="headerlink" title="结构"></a>结构</h2><p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210226002243394.png" alt="image-20210226002243394"></p>
<p>键对象一定为字符串对象, 值对象可以为字符串对象, 列表对象, 哈希对象, 集合对象或者有序集合对象中的一种</p>
<h3 id="encoding-1"><a href="#encoding-1" class="headerlink" title="encoding"></a>encoding</h3><p>各个对象类型对应的底层实现:</p>
<p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210226003249831.png" alt="image-20210226003249831"></p>
<p>对象类型 (TYPE命令的输出):</p>
<p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210226002559898.png" alt="image-20210226002559898"></p>
<p>编码对应的底层数据结构 (OBJECT ENCODING的输出):</p>
<p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210226003431546.png" alt="image-20210226003431546"></p>
<p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210226003456329.png" alt="image-20210226003456329"></p>
<h2 id="字符串对象"><a href="#字符串对象" class="headerlink" title="字符串对象"></a>字符串对象</h2><h3 id="编码格式"><a href="#编码格式" class="headerlink" title="编码格式"></a>编码格式</h3><ul>
<li>int: 保存整数值, 且可以用long表示 (void*转换成long)<ul>
<li><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210226003808306.png" alt="image-20210226003808306"></li>
</ul>
</li>
<li>raw: 字符串值, 且长度大于32字节, 使用SDS存储<ul>
<li>两次内存分配, 分别分配redisObject和sdshdr结构</li>
<li><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210226003940391.png" alt="image-20210226003940391"></li>
</ul>
</li>
<li>embstr: 字符串值, 且长度小于等于32字节<ul>
<li>一次内存分配, redisObject和sdshdr存储在一块连续的空间</li>
<li><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210226004231224.png" alt="image-20210226004231224"></li>
<li><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210226004248255.png" alt="image-20210226004248255"></li>
</ul>
</li>
</ul>
<p>浮点数在Redis中也作为字符串存储, 且编码为embstr或raw</p>
<h3 id="编码转换"><a href="#编码转换" class="headerlink" title="编码转换"></a>编码转换</h3><p>转换方向:</p>
<ul>
<li><p>int -&gt; raw</p>
</li>
<li><p>embstr -&gt; raw</p>
</li>
</ul>
<p>转换情况:</p>
<ul>
<li>int值追加了字符串, int -&gt; raw</li>
<li>对embstr (只读)进行修改, embstr -&gt; raw</li>
</ul>
<h2 id="列表对象"><a href="#列表对象" class="headerlink" title="列表对象"></a>列表对象</h2><h3 id="编码格式-1"><a href="#编码格式-1" class="headerlink" title="编码格式"></a>编码格式</h3><ul>
<li><p>ziplist: 压缩列表, 每个entry存储一个列表元素</p>
<ul>
<li><p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210227174824402.png" alt="image-20210227174824402"></p>
<p>三个元素: 1, “three”, 5</p>
</li>
</ul>
</li>
<li><p>linkedlist: 双端链表</p>
<ul>
<li><p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210227175048068.png" alt="image-20210227175048068"></p>
<p>链表底层对象是字符串对象 (字符串对象是Redis五种类型对象中唯一一种可能被嵌套的对象类型)</p>
</li>
</ul>
</li>
</ul>
<h3 id="编码转换-1"><a href="#编码转换-1" class="headerlink" title="编码转换"></a>编码转换</h3><p>使用ziplist编码的情况:</p>
<ul>
<li>列表对象保存的所有字符串元素的长度都小于64字节</li>
<li>元素数量小于等于512个</li>
</ul>
<p>其他情况将转为使用linkedlist编码</p>
<h2 id="哈希对象"><a href="#哈希对象" class="headerlink" title="哈希对象"></a>哈希对象</h2><h3 id="编码格式-2"><a href="#编码格式-2" class="headerlink" title="编码格式"></a>编码格式</h3><ul>
<li><p>ziplist: 压缩列表. 键值对保存成两个entry存储在相邻位置</p>
<ul>
<li><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210227180908219.png" alt="image-20210227180908219"></li>
<li><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210227181005751.png" alt="image-20210227181005751"></li>
</ul>
</li>
<li><p>hashtable: 字典. 字典的</p>
<ul>
<li>键值对的键和值都是字符串对象</li>
<li><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210227181758646.png" alt="image-20210227181758646"></li>
</ul>
</li>
</ul>
<h3 id="编码转换-2"><a href="#编码转换-2" class="headerlink" title="编码转换"></a>编码转换</h3><p>使用ziplist编码:</p>
<ul>
<li>所有键值对的键和值的字符串长度都小于64字节 (可配置hash-max-ziplist-value)</li>
<li>键值对数量小于等于512个 (可配置hash-max-ziplist-entries)</li>
</ul>
<p>其他情况转换为使用hashtable</p>
<h2 id="集合对象"><a href="#集合对象" class="headerlink" title="集合对象"></a>集合对象</h2><h3 id="编码格式-3"><a href="#编码格式-3" class="headerlink" title="编码格式"></a>编码格式</h3><ul>
<li>intset: 整数集合<ul>
<li><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210227224940968.png" alt="image-20210227224940968"></li>
</ul>
</li>
<li>hashtable: 字典, 每个键是一个字符串对象, 值为NULL<ul>
<li><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210227224959524.png" alt="image-20210227224959524"></li>
</ul>
</li>
</ul>
<h3 id="编码转换-3"><a href="#编码转换-3" class="headerlink" title="编码转换"></a>编码转换</h3><p>使用intset编码:</p>
<ul>
<li>所有元素都是整数值</li>
<li>元素数量不超过512个 (可配置set-max-intset-entries)</li>
</ul>
<p>其他情况则转换为hashtable</p>
<h2 id="有序集合对象"><a href="#有序集合对象" class="headerlink" title="有序集合对象"></a>有序集合对象</h2><h3 id="编码格式-4"><a href="#编码格式-4" class="headerlink" title="编码格式"></a>编码格式</h3><ul>
<li><p>ziplist: 压缩列表. 两个相邻节点来保存, 元素成员 + 分值</p>
<ul>
<li><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210227225500171.png" alt="image-20210227225500171"></li>
<li><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210227225509830.png" alt="image-20210227225509830"></li>
</ul>
</li>
<li><p>skiplist: 使用zset作为作为底层实现, zset包含一个字典和跳跃表. </p>
<ul>
<li><pre><code class="c">typedef struct zset &#123;
    zskiplist *zsl;
  dict *dict;
&#125;
</code></pre>
</li>
<li><p>zsl跳跃表: 节点object保存元素的成员, score保存了元素的分值</p>
</li>
<li><p>dict: 成员到分值的映射, O(1)复杂度查找成员的分值</p>
</li>
<li><p>zsl和dict通过指针共享相同元素的成员和分值 (分值是double应该是不需要共享的)</p>
</li>
<li><p>成员是字符串对象, 分值是一个double类型的浮点数</p>
</li>
<li><p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210227232410389.png" alt="image-20210227232410389"></p>
</li>
<li><p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210227232456947.png" alt="image-20210227232456947"></p>
</li>
<li><p>上图中没有展现出共享成员, 实际上zsl和dict是共享成员的</p>
</li>
</ul>
</li>
</ul>
<h3 id="编码转换-4"><a href="#编码转换-4" class="headerlink" title="编码转换"></a>编码转换</h3><p>使用ziplist编码:</p>
<ul>
<li>所有元素长度都小于64字节 (zset-max-ziplist-value)</li>
<li>元素数量小于128个 (zset-max-ziplist-entries)</li>
</ul>
<p>其他情况转换为skiplist编码</p>
<h2 id="类型检查与命令多态"><a href="#类型检查与命令多态" class="headerlink" title="类型检查与命令多态"></a>类型检查与命令多态</h2><p>针对命令执行的对象命令可分为两种类型:</p>
<ul>
<li>通用命令: 对任何类型的键执行<ul>
<li>DEL, EXPIRE, RENAME</li>
</ul>
</li>
<li>类型特定命令: 一些命令只能对特定类型的键执行<ul>
<li>只能对字符串键执行: SET, GET, APPEND, STRLEN等</li>
<li>只能对哈希键执行: HDEL, HSET, HGET, HLEN等</li>
<li>只能对列表键执行: RPUSH, LPOP, LINSERT, LLEN等</li>
<li>集合键: SADD, SPOP, SINTER, SCARD等</li>
<li>有序集合键: ZADD, ZCARD, ZRANK, ZSCORE</li>
</ul>
</li>
</ul>
<h3 id="类型检查的实现"><a href="#类型检查的实现" class="headerlink" title="类型检查的实现"></a>类型检查的实现</h3><p>类型特定命令的类型检查是通过redisObject结构的type属性来实现的</p>
<p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210227233523722.png" alt="image-20210227233523722"></p>
<h3 id="多态命令的实现"><a href="#多态命令的实现" class="headerlink" title="多态命令的实现"></a>多态命令的实现</h3><p>多态命令类型:</p>
<ul>
<li>基于类型的多态: 一个命令能同时处理多种不同类型的键, 如DEL, EXPIRE, TYPE等</li>
<li>基于编码的多态: 一个命令能同时用于处理多种不同编码, 如LLEN等</li>
</ul>
<p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210227233842418.png" alt="image-20210227233842418"></p>
<h3 id="内存回收"><a href="#内存回收" class="headerlink" title="内存回收"></a>内存回收</h3><p>Reidis基于引用计数技术实现的内存回收</p>
<p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210227233929371.png" alt="image-20210227233929371"></p>
<p>引用计数变化形式:</p>
<ul>
<li>创建一个新对象, refcount = 1</li>
<li>对象被一个新程序使用, refcount++</li>
<li>对象不再被一个程序使用, refcount–</li>
<li>refcount == 0, 对象被释放</li>
</ul>
<h3 id="对象共享"><a href="#对象共享" class="headerlink" title="对象共享"></a>对象共享</h3><p>基于refcount实现对象共享.</p>
<p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210227234333432.png" alt="image-20210227234333432"></p>
<p>Redis在初始化服务器时, 会创建一万个整数值字符串对象 (0~9999). (可修改redis.h/REDIS_SHARED_INTEGERS)</p>
<p>Redis支队包含整数值的字符串进行共享 (感觉应该也只有初始化的整形字符串对象才被共享)</p>
<h3 id="对象的空转时长"><a href="#对象的空转时长" class="headerlink" title="对象的空转时长"></a>对象的空转时长</h3><p>对象最后一次被命令访问的时间 = 当前时间 - lru时间</p>
<p><img src="/2021/02/19/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/image-20210228002000143.png" alt="image-20210228002000143"></p>
<p>如果服务器打开了maxmemory选项, 且内存回收算法为volatile-lru或allkeys-lru, 那么空转时间较长的那部分键会优先被服务器释放</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dongrongyu.github.io/2020/11/23/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-Chapter-11-14/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Rongyu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rongyu's BigHouse">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/23/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-Chapter-11-14/" class="post-title-link" itemprop="url">Redis设计与实现 Chapter 11-14</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-11-23 12:26:53 / 修改时间：13:13:05" itemprop="dateCreated datePublished" datetime="2020-11-23T12:26:53+08:00">2020-11-23</time>
            </span>

          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="AOF持久化"><a href="#AOF持久化" class="headerlink" title="AOF持久化"></a>AOF持久化</h1><p>AOF通过保存所有修改数据库的<strong>写命令请求</strong>来记录服务器数据库状态</p>
<p>以Redis<strong>命令请求协议</strong>的格式保存</p>
<p>写命令 -&gt; AOF缓冲区 -&gt; 同步写入到AOF文件</p>
<p>appendfsync选项:</p>
<ul>
<li>always: 写入 + 同步</li>
<li>everysec: 写入 + 每秒同步</li>
<li>no: 仅写入不同步, 同步依赖操作系统</li>
</ul>
<p>服务器启动后载入数据优先通过AOF文件</p>
<p>AOF重写:</p>
<ul>
<li>重写后文件体积更小</li>
<li>通过读取数据库中的键值对实现, 并不是读原有AOF文件</li>
</ul>
<p>执行BGWRITEAOF命令:</p>
<ul>
<li>期间维护一个AOF重写缓冲区, 记录重写过程中服务器执行的写命令</li>
<li>重写执行完后, AOF重写缓冲区中的内容追加到新AOF文件末尾, 使新旧文件保存的数据库状态一致</li>
<li>用新AOF文件替换旧文件</li>
</ul>
<h1 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h1><p>类型:</p>
<ul>
<li><p>文件事件:</p>
<ul>
<li>对socket的抽象, 套接字变为acceptable、writable、readable状态时, 相应文件事件就会产生</li>
<li>基于Reactor模式实现的网络通信程序</li>
<li>AE_READABLE和AE_WRITABLE事件</li>
</ul>
</li>
<li><p>时间事件:</p>
<ul>
<li>定时事件、周期性事件</li>
<li>一般情况下只执行serverCron函数一个时间事件 (但这个函数执行了很多内容)</li>
<li>事件loop中, 先处理文件事件, 后处理时间事件. 处理过程中不抢占</li>
</ul>
</li>
</ul>
<h1 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h1><p>clients链表连接了多个客户端状态, 新增加的客户端添加到链表末尾</p>
<p>客户端关闭情况:</p>
<ul>
<li>网络连接关闭</li>
<li>发送了不合协议格式的命令请求</li>
<li>CLIENT KILL</li>
<li>空转事件超时</li>
<li>输出缓冲区大小超出限制</li>
</ul>
<p>伪客户端:</p>
<ul>
<li>处理Lua脚本的伪客户端: 初始化创建, 一直存在</li>
<li>载入AOF文件的伪客户端: 载入工作创建, 完成后关闭</li>
</ul>
<p>flags标识客户端的角色和状态</p>
<p>输入缓冲区记录命令请求, 大小不能超过1GB</p>
<p>命令参数和参数个数纪录在argv和argc</p>
<p>cmd指向RedisCommand, 记录命令实现函数</p>
<p>输出缓冲区:</p>
<ul>
<li>固定大小缓冲区, 16KB</li>
<li>可变大小缓冲区, StringObject链表, 不能超过限制值<ul>
<li>硬性限制: 超过则关闭连接</li>
<li>软性限制: 一定时间内一直超过则关闭</li>
</ul>
</li>
</ul>
<h1 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h1><p>命令请求从发送到完成的步骤:</p>
<ol>
<li>客户端发请求给服务器</li>
<li>server读取命令, 解析命令参数</li>
<li>根据命令查找实现函数, 执行命令并得出命令回复</li>
<li>server将命令回复返回给客户端</li>
</ol>
<p>serverCron: 每100ms执行一次</p>
<ul>
<li>更新服务器状态信息</li>
<li>处理SIGTERM信号</li>
<li>管理客户端资源和数据库状态</li>
<li>检查并执行持久化操作</li>
<li>…</li>
</ul>
<p>服务器初始化步骤:</p>
<ul>
<li>初始化服务器状态</li>
<li>initServerConfig, 载入服务器配置, 创建命令表</li>
<li>initServer, 初始化服务器数据结构: server.clients客户端状态链表, server.db数据库数组, server.pubsub_channels频道订阅信息的字典, server.pubsub_patterns模式订阅信息的链表、server.lua用于执行Lua脚本的Lua环境, server.slowlog用于保存满查询日志的属性</li>
<li>还原数据库状态: AOF、RDB</li>
<li>执行事件循环: 文件事件 + 时间时间</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dongrongyu.github.io/2020/11/09/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-Chapter-8-10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Rongyu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rongyu's BigHouse">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/09/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-Chapter-8-10/" class="post-title-link" itemprop="url">Redis设计与实现 Chapter 8-10</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-09 11:52:56" itemprop="dateCreated datePublished" datetime="2020-11-09T11:52:56+08:00">2020-11-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-11-23 12:27:09" itemprop="dateModified" datetime="2020-11-23T12:27:09+08:00">2020-11-23</time>
              </span>

          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h1><p>五种对象类型, 美中至少有两种以上的编码方式, 优化在不同场景的使用效率</p>
<table>
<thead>
<tr>
<th>对象类型</th>
<th>编码方式</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>字符串对象</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>列表对象</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>哈希对象</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>集合对象</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>有序集合对象</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>服务器在执行命令之前, 会检查给定键的<strong>值对象类型</strong>能否执行指定的命令</p>
<p>内存回收通过<strong>引用计数</strong>实现</p>
<p>Redis只共享整数类型的字符串对象, 初始化时设置, 默认为0~9999</p>
<p>redistObject中的<strong>lru属性</strong>用于记录最后一次被访问的时间, 这个时间可以用于计算空转时间</p>
<h1 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h1><p>redisServer.db存储所有的数据库, redisServer.dbnum属性保存数据库数量</p>
<p>客户端SELECT命令修改数据库, 让它指向redistServer.db中的不同元素来切换数据库</p>
<p>数据库主要有两个字典构成:</p>
<ul>
<li>dict: 保存数据库的所有键值对</li>
<li>expires: 保存键的过期时间, 键只想dict中的某个键, 值是过期时间</li>
</ul>
<p>数据库健总是一个字符串对象, 值可以是字符串对象、哈希表对象、集合对象、列表对象、有序集合对象</p>
<p>Redist过期健删除策略: 惰性删除 + 定期删除</p>
<p>SAVE和BGSVAE命令产生的新RDB文件不会包含已过期的键</p>
<p>过期键被删除后, 会追加一条DEL命令到AOF文件末尾</p>
<p>主服务器删除一个过期键后, 会向所有 从服务器发送一条DEL命令</p>
<p>从服务器发现过期键也不会删除</p>
<p>当Redis对数据库进行修改后, 会根据配置向客户端发送数据库通知</p>
<h1 id="RDB持久化"><a href="#RDB持久化" class="headerlink" title="RDB持久化"></a>RDB持久化</h1><p>RDB用于存储和还原Redis服务器中所有键值对数据</p>
<p>保存数据库到RDB:</p>
<ul>
<li>SAVE指令, 阻塞服务器进程保存数据库</li>
<li>BGSAVE指令: 生成子进程保存数据库, 不会阻塞服务器. 期间<ul>
<li>SAVE命令被拒绝</li>
<li>BGSAVE命令被拒绝</li>
<li>不能和BGREWRITEAOF同时执行, BGREWRITEAOF会被延迟到BGSAVE结束后执行</li>
</ul>
</li>
</ul>
<p>save选项设置服务器自动保存的条件</p>
<ul>
<li>save 300 10</li>
</ul>
<p>RDB是一个经过压缩的二进制文件, 不同类型的键值对以不同的方式来保存</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Rongyu"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Rongyu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">19</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/dongrongyu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;dongrongyu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:rongyu.dong@gmail.com" title="E-Mail → mailto:rongyu.dong@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Rongyu</span>
</div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>



        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '3nDJCTt3PoQ9qeabywtgL5qQ-gzGzoHsz',
      appKey     : 'HMGLSYCgLRuL0Tst8VMocAfj',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
